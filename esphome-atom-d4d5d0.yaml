esphome:
  name: esphome-web-d4d5d0
  friendly_name: m5Stack Echo d4d5d0
  min_version: 2025.9.0
  name_add_mac_suffix: false

# Load custom components from local directory
# Off-device inference: ESP32 streams audio, server does NN detection, sends result back
external_components:
  - source:
      type: local
      path: components
    components: [audio_streamer, detection_receiver]

esp32:
  variant: esp32
  framework:
    type: esp-idf

# Enable logging
logger:
  level: DEBUG # Set to INFO in production
  logs:
    audio_streamer: DEBUG
    detection_receiver: DEBUG
    i2s_audio: DEBUG

# Enable Home Assistant API
api:

# Allow Over-The-Air updates
ota:
  - platform: esphome

wifi:
  ssid: "Goshen"
  password: "@WeRHere"

# I2S Microphone Configuration (M5Stack Atom Echo SPM1423)
i2s_audio:
  - id: i2s_mic_bus
    i2s_lrclk_pin: GPIO33
    i2s_bclk_pin: GPIO19

microphone:
  - platform: i2s_audio
    id: echo_microphone
    i2s_audio_id: i2s_mic_bus
    i2s_din_pin: GPIO23
    adc_type: external
    pdm: true
    sample_rate: 16000
    bits_per_sample: 16bit
    channel: left

# ============================================
# Off-Device Inference Architecture:
#   ESP32 --UDP audio--> Server (NN) --UDP detection--> ESP32 --API--> Home Assistant
# ============================================

# Audio Streamer: Sends microphone audio to server via UDP
audio_streamer:
  id: audio_streamer_component
  microphone: echo_microphone
  target_ip: "192.168.86.40" # Server running audio_server.py (update to your server IP)
  target_port: 5050 # Server listens on this port
  sample_rate: 16000
  chunk_size: 512 # Samples per UDP packet

# Detection Receiver: Receives NN detection results from server
detection_receiver:
  id: detection_receiver_component
  port: 5001 # Listen for detection results from server

  # Binary sensor for beep detection state
  binary_sensor:
    name: "Beep Detected"
    device_class: sound
    filters:
      - delayed_off: 100ms # Keep state ON briefly for visibility
    on_press:
      # Fire HA event for automations
      - homeassistant.event:
          event: esphome.beep_detected
          data:
            device: "m5stack_echo"
            message: "Beep detected by neural network!"

  # Confidence sensor (0.0 - 1.0)
  confidence_sensor:
    name: "Beep Confidence"

  # Detection count
  detection_count:
    name: "Total Beep Detections"

# ============================================
# Runtime Controls
# ============================================

switch:
  - platform: template
    name: "Audio Streaming Enabled"
    id: streaming_enabled
    icon: "mdi:microphone"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON # Auto-start streaming
    turn_on_action:
      - lambda: "id(audio_streamer_component).set_enabled(true);"
    turn_off_action:
      - lambda: "id(audio_streamer_component).set_enabled(false);"

button:
  - platform: template
    name: "Reset Detection Count"
    icon: "mdi:counter"
    on_press:
      - lambda: "id(detection_receiver_component).reset_detection_count();"

  - platform: restart
    name: "Restart Device"

# Device diagnostics
sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    update_interval: 60s
