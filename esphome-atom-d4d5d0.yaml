esphome:
  name: esphome-web-d4d5d0
  friendly_name: m5Stack Echo d4d5d0
  min_version: 2025.9.0
  name_add_mac_suffix: false

# Load custom beep_detector component from GitHub
external_components:
  - source:
      type: git
      url: https://github.com/samuelmukoti/esphome-audio-sensor
      ref: main
    components: [audio_streamer, beep_detector_nn]
    refresh: 0s

esp32:
  variant: esp32
  framework:
    type: esp-idf

# Enable logging
logger:
  level: DEBUG  # Set to INFO in production
  logs:
    beep_detector_nn: DEBUG
    i2s_audio: DEBUG

# Enable Home Assistant API
api:

# Allow Over-The-Air updates
ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# I2S Microphone Configuration (M5Stack Atom Echo SPM1423)
i2s_audio:
  - id: i2s_mic_bus
    i2s_lrclk_pin: GPIO33
    i2s_bclk_pin: GPIO19

microphone:
  - platform: i2s_audio
    id: echo_microphone
    i2s_audio_id: i2s_mic_bus
    i2s_din_pin: GPIO23
    adc_type: external
    pdm: true
    sample_rate: 16000
    bits_per_sample: 16bit
    channel: left
    # DC offset removal handled in beep_detector C++ code

# Neural Network Beep Detector Component
# Uses trained CNN model for robust beep detection
beep_detector_nn:
  id: beep_detector_nn_component
  microphone: echo_microphone

  # Detection Parameters
  sample_rate: 16000          # Hz - must match microphone
  window_size_ms: 500         # ms - analysis window (matches training)
  confidence_threshold: 0.7   # NN confidence threshold (0.0-1.0)
  debounce_count: 2           # consecutive detections required

  # Binary sensor for beep detection state
  binary_sensor:
    name: "Beep Detected (NN)"
    device_class: sound
    filters:
      - delayed_off: 100ms  # Keep state ON briefly for visibility
    on_press:
      # Fire HA event for automations
      - homeassistant.event:
          event: esphome.beep_detected
          data:
            device: "m5stack_echo"
            message: "Beep detected by neural network!"

  # Confidence sensor (0.0 - 1.0)
  confidence_sensor:
    name: "Beep Confidence"

  # Detection count
  detection_count:
    name: "Total Beep Detections (NN)"

# ============================================
# Audio Streaming for Debugging
# ============================================
# Streams raw audio over UDP to a Python server for analysis
# Set target_ip to your computer's IP address running audio_server.py
audio_streamer:
  id: audio_stream_component
  microphone: echo_microphone
  target_ip: "192.168.1.100"  # CHANGE THIS to your computer's IP
  target_port: 5000
  sample_rate: 16000
  enabled: false  # Start disabled, enable from HA when needed

# ============================================
# Runtime Tuning Controls (adjustable from HA)
# ============================================

switch:
  - platform: template
    name: "NN Beep Detection Enabled"
    id: nn_detection_enabled
    icon: "mdi:brain"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    turn_on_action:
      - lambda: 'id(beep_detector_nn_component).set_enabled(true);'
    turn_off_action:
      - lambda: 'id(beep_detector_nn_component).set_enabled(false);'

  - platform: template
    name: "Audio Streaming"
    id: audio_streaming_enabled
    icon: "mdi:broadcast"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - lambda: 'id(audio_stream_component).start_streaming();'
    turn_off_action:
      - lambda: 'id(audio_stream_component).stop_streaming();'

button:
  - platform: template
    name: "Reset NN Detection Count"
    icon: "mdi:counter"
    on_press:
      - lambda: 'id(beep_detector_nn_component).reset_detection_count();'

  - platform: restart
    name: "Restart Device"

# Device diagnostics
sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  - platform: uptime
    name: "Uptime"
    update_interval: 60s
